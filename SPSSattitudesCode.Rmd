---
title: "SPSS Attitudes Measure Validation"
author: "Carmen Dang"
date: "13/07/2020"
output: html_document
        md_keep = TRUE
---

```{r Loading Packages, echo = FALSE}
library(readr)
library(haven)
library(tidyverse)
library(lavaan)
library(psych)
library(mirt)
library(rsample)
```

```{r Uploading data and cleaning}
# Uploading raw data
full.data <- readxl::read_xlsx("spssdata.xlsx", col_names = TRUE)
# Remove empty rows
full.data <- full.data[1:181, ]

# Selecting only SPSS-related columns
  # Do not select StudentIDE col bc it'd be included with EFA/CFA
  # Num of rows corresponds to StudentIDE
spss.data <- full.data %>% 
             select(SPSS1E,
                    SPSS2E,
                    SPSS3E,
                    SPSS4E,
                    SPSS5E,
                    SPSS6E,
                    SPSS7E,
                    SPSS8E,
                    SPSS9E,
                    SPSS10E)

# Reverse code SPSS items 2, 3, 10
spss.data$SPSS2E <- car::recode(spss.data$SPSS2E, "1 = 5; 2 = 4; 3 = 3; 4 = 2; 5 = 1")
spss.data$SPSS3E <- car::recode(spss.data$SPSS3E, "1 = 5; 2 = 4; 3 = 3; 4 = 2; 5 = 1")
spss.data$SPSS10E <- car::recode(spss.data$SPSS10E, "1 = 5; 2 = 4; 3 = 3; 4 = 2; 5 = 1")
```

```{r Descriptive Stats}
describe(spss.data)

# Contingency table of the counts
table(spss.data$SPSS1E)
table(spss.data$SPSS2E)
table(spss.data$SPSS3E)
table(spss.data$SPSS4E)
table(spss.data$SPSS5E)
table(spss.data$SPSS6E)
table(spss.data$SPSS7E)
table(spss.data$SPSS8E)
table(spss.data$SPSS9E)
table(spss.data$SPSS10E)

## Missing Data Calculations ##
table(is.na(spss.data))

# FALSE  TRUE 
#  1988     3

# 3 / (3 + 1988) = 0.001506781
# 0.001506781 * 100 = 0.1506781

## Less than 1% missing data, proceeding with complete case analyses
```

```{r Splitting into EFA/CFA Sets}
# Default split is 75%/25%
# Default is no appropriate with our n = 181
# Zach suggests: EFA n = 81 and CFA n = 100
EFA_CFA_spss_split <- initial_split(spss.data, prop = .552)

EFA.spss <- testing(EFA_CFA_spss_split)
CFA.spss <- training(EFA_CFA_spss_split)
```

```{r MAP/Parallel}
VSS(EFA.spss, plot = F)
# 
# Very Simple Structure
# Call: vss(x = x, n = n, rotate = rotate, diagonal = diagonal, fm = fm, 
#     n.obs = n.obs, plot = plot, title = title, use = use, cor = cor)
# VSS complexity 1 achieves a maximimum of 0.89  with  2  factors
# VSS complexity 2 achieves a maximimum of 0.95  with  5  factors
# 
# The Velicer MAP achieves a minimum of 0.05  with  2  factors 
# BIC achieves a minimum of  NA  with  2  factors
# Sample Size adjusted BIC achieves a minimum of  NA  with  4  factors


fa.parallel(EFA.spss, fm="ml", fa='both', n.iter=100)
# Statistics by number of factors 
# Parallel analysis suggests that the number of factors =  2  and the number of components =  2 
# If num. of components = NA bc fa = 'fa' produces factors, fa = 'pc' produces components, fa = 'both'
```

```{r EFAs}
# Zach prefers promax rotation. Promax is most common, but does not achieve a simple structure as well as other oblique rotations
  # Alyssa prefers oblimin
# fm. minres/ULS (default) does not assume multivariate normality, ML does.
  # Let's do ULS for now until assumptions are checked
```

```{r 1f uls oblimin}
fa(EFA.spss, nfactors = 1, fm = "uls", rotate = "oblimin")
# Factor Analysis using method =  uls
# Call: fa(r = EFA.spss, nfactors = 1, rotate = "oblimin", fm = "uls")
# Standardized loadings (pattern matrix) based upon correlation matrix
# 
#                ULS1
# SS loadings    4.38
# Proportion Var 0.44
# 
# Mean item complexity =  1
# Test of the hypothesis that 1 factor is sufficient.
# 
# The degrees of freedom for the null model are  45  and the objective function was  6.15 with Chi Square of  466.51
# The degrees of freedom for the model are 35  and the objective function was  1.45 
# 
# The root mean square of the residuals (RMSR) is  0.14 
# The df corrected root mean square of the residuals is  0.16 
# 
# The harmonic number of observations is  81 with the empirical chi square  146.13  with prob <  1.6e-15 
# The total number of observations was  81  with Likelihood Chi Square =  109.1  with prob <  1.5e-09 
# 
# Tucker Lewis Index of factoring reliability =  0.772
# RMSEA index =  0.161  and the 90 % confidence intervals are  0.129 0.198
# BIC =  -44.7
# Fit based upon off diagonal values = 0.9
# Measures of factor score adequacy             
#                                                   ULS1
# Correlation of (regression) scores with factors   0.97
# Multiple R square of scores with factors          0.94
# Minimum correlation of possible factor scores     0.88
#
#         ULS1      h2        u2      com
# SPSS1E	0.86	0.74552130	0.2544787	1     
# SPSS2E	0.09	0.00858251	0.9914175	1     ULS1 + h2 <.4 | ULS1 < .29
# SPSS3E	0.32	0.10491166	0.8950883	1     ULS1 + h2 <.4
# SPSS4E	0.91	0.81917893	0.1808211	1
# SPSS5E	0.71	0.50122542	0.4987746	1
# SPSS6E	0.65	0.42209038	0.5779096	1
# SPSS7E	0.56	0.31257203	0.6874280	1     h2 <.4
# SPSS8E	0.84	0.71224267	0.2877573	1
# SPSS9E	0.87	0.75122549	0.2487745	1
# SPSS10E	0.06	0.00359231	0.9964077	1     ULS1 + h2 <.4 | ULS1 < .29

##########
## 1F model looks terrible. RMSR should be <.08
## Explains 44% of data
## Several factor loadings <.40 (Zach drops these items and re-runs EFA)
## Several communalities <.40 (variance of measure explained by common factors)
## 1F so no point in rotating
##########
```
```{r 2f uls oblimin}
fa(EFA.spss, nfactors = 2, fm = "uls", rotate = "oblimin")

# Factor Analysis using method =  uls
# Call: fa(r = EFA.spss, nfactors = 2, rotate = "oblimin", fm = "uls")
# Standardized loadings (pattern matrix) based upon correlation matrix
# 
#                       ULS1 ULS2
# SS loadings           4.33 1.65
# Proportion Var        0.43 0.17
# Cumulative Var        0.43 0.60
# Proportion Explained  0.72 0.28
# Cumulative Proportion 0.72 1.00
# 
#  With factor correlations of 
#      ULS1 ULS2
# ULS1 1.00 0.18
# ULS2 0.18 1.00
# 
# Mean item complexity =  1
# Test of the hypothesis that 2 factors are sufficient.
# 
# The degrees of freedom for the null model are  45  and the objective function was  6.15 with Chi Square of  466.51
# The degrees of freedom for the model are 26  and the objective function was  0.5 
# 
# The root mean square of the residuals (RMSR) is  0.04 
# The df corrected root mean square of the residuals is  0.05 
# 
# The harmonic number of observations is  81 with the empirical chi square  12.48  with prob <  0.99 
# The total number of observations was  81  with Likelihood Chi Square =  37.48  with prob <  0.068 
# 
# Tucker Lewis Index of factoring reliability =  0.952
# RMSEA index =  0.073  and the 90 % confidence intervals are  0 0.124
# BIC =  -76.77
# Fit based upon off diagonal values = 0.99
# Measures of factor score adequacy             
#                                                   ULS1 ULS2
# Correlation of (regression) scores with factors   0.97 0.91
# Multiple R square of scores with factors          0.94 0.82
# Minimum correlation of possible factor scores     0.88 0.64

#         ULS1  ULS2    h2        u2      com
# SPSS1E	0.83	0.11	0.7396673	0.2603327	1.034476
# SPSS2E	-0.06	0.62	0.3751281	0.6248719	1.021075     h2 <.4
# SPSS3E	0.16	0.81	0.7225141	0.2774859	1.074621
# SPSS4E	0.91	0.00	0.8236385	0.1763615	1.000032
# SPSS5E	0.71	0.01	0.5005313	0.4994687	1.000326
# SPSS6E	0.67	-0.05	0.4338667	0.5661333	1.013136
# SPSS7E	0.57	-0.04	0.3201593	0.6798407	1.011762     h2 <.4
# SPSS8E	0.82	0.10	0.7071139	0.2928861	1.029822
# SPSS9E	0.91	-0.11	0.8003972	0.1996028	1.031578
# SPSS10E	-0.13	0.76	0.5547013	0.4452987	1.061648

##########
# RMSR = .04 is good
# 2F explains 60% var, that is a 16% increase
# All factor loadings are >.4
# Some w. low communality
# Let's check out other rotations to change the loadings
##########
```
```{r 2f uls promax}
fa(EFA.spss, nfactors = 2, fm = "uls", rotate = "promax")

# Factor Analysis using method =  uls
# Call: fa(r = EFA.spss, nfactors = 2, rotate = "promax", fm = "uls")
# Standardized loadings (pattern matrix) based upon correlation matrix
# 
#                       ULS1 ULS2
# SS loadings           4.34 1.64
# Proportion Var        0.43 0.16
# Cumulative Var        0.43 0.60
# Proportion Explained  0.73 0.27
# Cumulative Proportion 0.73 1.00
# 
#  With factor correlations of 
#      ULS1 ULS2
# ULS1 1.00 0.14
# ULS2 0.14 1.00
# 
# Mean item complexity =  1
# Test of the hypothesis that 2 factors are sufficient.
# 
# The degrees of freedom for the null model are  45  and the objective function was  6.15 with Chi Square of  466.51
# The degrees of freedom for the model are 26  and the objective function was  0.5 
# 
# The root mean square of the residuals (RMSR) is  0.04 
# The df corrected root mean square of the residuals is  0.05 
# 
# The harmonic number of observations is  81 with the empirical chi square  12.48  with prob <  0.99 
# The total number of observations was  81  with Likelihood Chi Square =  37.48  with prob <  0.068 
# 
# Tucker Lewis Index of factoring reliability =  0.952
# RMSEA index =  0.073  and the 90 % confidence intervals are  0 0.124
# BIC =  -76.77
# Fit based upon off diagonal values = 0.99
# Measures of factor score adequacy             
#                                                   ULS1 ULS2
# Correlation of (regression) scores with factors   0.97 0.91
# Multiple R square of scores with factors          0.94 0.82
# Minimum correlation of possible factor scores     0.88 0.64

#         ULS1  ULS2      h2        u2      com
# SPSS1E	0.84	0.11	0.7396673	0.2603327	1.035452
# SPSS2E	-0.04	0.62	0.3751281	0.6248719	1.008733
# SPSS3E	0.19	0.80	0.7225141	0.2774859	1.106742
# SPSS4E	0.91	0.00	0.8236385	0.1763615	1.000001
# SPSS5E	0.71	0.01	0.5005313	0.4994687	1.000505
# SPSS6E	0.66	-0.05	0.4338667	0.5661333	1.012057
# SPSS7E	0.57	-0.04	0.3201593	0.6798407	1.010741
# SPSS8E	0.82	0.10	0.7071139	0.2928861	1.030797
# SPSS9E	0.90	-0.11	0.8003972	0.1996028	1.029939
# SPSS10E	-0.10	0.75	0.5547013	0.4452987	1.038919

##########
# Factor loadings did not change much
# Open to trying other rotations as well
##########
```
```{r Assumptions}
# NOTE: not very confident abt assumptions - need some guidance

# ML assumptions
  # "multicollinearity" - factors should be highly correlated, but not = 1
  # Aiming for a significant Bartlett's test
    # Not usually tested bc EFA requires large N which usually makes Bartlett's test sig.
correlations = cor(EFA.spss, use = "complete.obs")
cortest.bartlett(correlations, n = nrow(EFA.spss))
# linearity assumptions
  # TBD
# observed variables are multivariate normality
MVN::mvn(EFA.spss)
  # Output: multivariate tests + p vals, univariate normality, descriptive stats

# Other assumptions
  # Large enough sample size?
    # .9+ = yay, .8 = yayish, .7 = ok, .6 = meh, <.5 = bad
KMO(correlations)
  # Need at least 3-4 items per factor
```
# Let's try ml..

```{r}
fa(EFA.spss, nfactors = 1, fm = "ml", rotate = "oblimin")
# 
# Factor Analysis using method =  ml
# Call: fa(r = EFA.spss, nfactors = 1, rotate = "oblimin", fm = "ml")
# Standardized loadings (pattern matrix) based upon correlation matrix
# 
#                 ML1
# SS loadings    4.36
# Proportion Var 0.44
# 
# Mean item complexity =  1
# Test of the hypothesis that 1 factor is sufficient.
# 
# The degrees of freedom for the null model are  45  and the objective function was  6.15 with Chi Square of  466.51
# The degrees of freedom for the model are 35  and the objective function was  1.43 
# 
# The root mean square of the residuals (RMSR) is  0.14 
# The df corrected root mean square of the residuals is  0.16 
# 
# The harmonic number of observations is  81 with the empirical chi square  149.67  with prob <  3.9e-16 
# The total number of observations was  81  with Likelihood Chi Square =  107.39  with prob <  2.8e-09 
# 
# Tucker Lewis Index of factoring reliability =  0.777
# RMSEA index =  0.159  and the 90 % confidence intervals are  0.127 0.196
# BIC =  -46.41
# Fit based upon off diagonal values = 0.9
# Measures of factor score adequacy             
#                                                    ML1
# Correlation of (regression) scores with factors   0.97
# Multiple R square of scores with factors          0.94
# Minimum correlation of possible factor scores     0.89
# 

#         ML1       h2            u2  com
# SPSS1E	0.86	0.7435789512	0.2564210	1   
# SPSS2E	0.04	0.0012337124	0.9987663	1   ML1 <.4 | h2 <.4 | ML1 < .29
# SPSS3E	0.32	0.1000876158	0.8999124	1   ML1 <.4 | h2 <.4
# SPSS4E	0.92	0.8486042664	0.1513957	1
# SPSS5E	0.70	0.4906327942	0.5093672	1
# SPSS6E	0.66	0.4295388279	0.5704612	1
# SPSS7E	0.54	0.2965556374	0.7034444	1   h2 <.4
# SPSS8E	0.81	0.6632291405	0.3367709	1
# SPSS9E	0.89	0.7876013660	0.2123986	1
# SPSS10E	0.02	0.0005946782	0.9994053	1   ML1 <.4 | h2 <.4 | ML1 < .29

##########
# RMSR <.14
# explains 44% of var
# many factor loadings <.4, some <.29
# some communality <.4
##########
```
```{r}
fa(EFA.spss, nfactors = 2, fm = "ml", rotate = "oblimin")

# Factor Analysis using method =  ml
# Call: fa(r = EFA.spss, nfactors = 2, rotate = "oblimin", fm = "ml")
# Standardized loadings (pattern matrix) based upon correlation matrix
# 
#                        ML1  ML2
# SS loadings           4.31 1.65
# Proportion Var        0.43 0.16
# Cumulative Var        0.43 0.60
# Proportion Explained  0.72 0.28
# Cumulative Proportion 0.72 1.00
# 
#  With factor correlations of 
#      ML1  ML2
# ML1 1.00 0.16
# ML2 0.16 1.00
# 
# Mean item complexity =  1
# Test of the hypothesis that 2 factors are sufficient.
# 
# The degrees of freedom for the null model are  45  and the objective function was  6.15 with Chi Square of  466.51
# The degrees of freedom for the model are 26  and the objective function was  0.48 
# 
# The root mean square of the residuals (RMSR) is  0.04 
# The df corrected root mean square of the residuals is  0.06 
# 
# The harmonic number of observations is  81 with the empirical chi square  14.03  with prob <  0.97 
# The total number of observations was  81  with Likelihood Chi Square =  36.04  with prob <  0.091 
# 
# Tucker Lewis Index of factoring reliability =  0.958
# RMSEA index =  0.068  and the 90 % confidence intervals are  0 0.12
# BIC =  -78.21
# Fit based upon off diagonal values = 0.99
# Measures of factor score adequacy             
#                                                    ML1  ML2
# Correlation of (regression) scores with factors   0.97 0.90
# Multiple R square of scores with factors          0.95 0.81
# Minimum correlation of possible factor scores     0.89 0.61
# 
#         ML1   ML2       h2        u2      com
# SPSS1E	0.84	0.11	0.7442887	0.2557113	1.032725
# SPSS2E	-0.08	0.64	0.3961480	0.6038520	1.033308    h2 < .4
# SPSS3E	0.19	0.77	0.6793245	0.3206755	1.117093
# SPSS4E	0.92	0.00	0.8502506	0.1497494	1.000012
# SPSS5E	0.70	0.00	0.4855031	0.5144969	1.000022
# SPSS6E	0.67	-0.06	0.4348229	0.5651771	1.016416
# SPSS7E	0.55	-0.05	0.2978138	0.7021862	1.018181    h2 < .4
# SPSS8E	0.79	0.11	0.6706395	0.3293605	1.037396
# SPSS9E	0.92	-0.11	0.8180204	0.1819796	1.028175
# SPSS10E	-0.12	0.78	0.5874262	0.4125738	1.047000

##########
# RMSR = .04
# Explains 60% of var, that's a 16% increase
##########

```
```{r}
fa(EFA.spss, nfactors = 2, fm = "ml", rotate = "promax")

# Factor Analysis using method =  ml
# Call: fa(r = EFA.spss, nfactors = 2, rotate = "promax", fm = "ml")
# Standardized loadings (pattern matrix) based upon correlation matrix
# 
#                        ML1  ML2
# SS loadings           4.32 1.65
# Proportion Var        0.43 0.16
# Cumulative Var        0.43 0.60
# Proportion Explained  0.72 0.28
# Cumulative Proportion 0.72 1.00
# 
#  With factor correlations of 
#      ML1  ML2
# ML1 1.00 0.13
# ML2 0.13 1.00
# 
# Mean item complexity =  1
# Test of the hypothesis that 2 factors are sufficient.
# 
# The degrees of freedom for the null model are  45  and the objective function was  6.15 with Chi Square of  466.51
# The degrees of freedom for the model are 26  and the objective function was  0.48 
# 
# The root mean square of the residuals (RMSR) is  0.04 
# The df corrected root mean square of the residuals is  0.06 
# 
# The harmonic number of observations is  81 with the empirical chi square  14.03  with prob <  0.97 
# The total number of observations was  81  with Likelihood Chi Square =  36.04  with prob <  0.091 
# 
# Tucker Lewis Index of factoring reliability =  0.958
# RMSEA index =  0.068  and the 90 % confidence intervals are  0 0.12
# BIC =  -78.21
# Fit based upon off diagonal values = 0.99
# Measures of factor score adequacy             
#                                                    ML1  ML2
# Correlation of (regression) scores with factors   0.97 0.90
# Multiple R square of scores with factors          0.95 0.81
# Minimum correlation of possible factor scores     0.89 0.61
# 
#          ML1   ML2       h2        u2      com
# SPSS1E	0.84	0.11	0.7442887	0.2557113	1.034661
# SPSS2E	-0.07	0.63	0.3961480	0.6038520	1.021465
# SPSS3E	0.21	0.77	0.6793245	0.3206755	1.143743
# SPSS4E	0.92	0.00	0.8502506	0.1497494	1.000009
# SPSS5E	0.70	0.01	0.4855031	0.5144969	1.000123
# SPSS6E	0.66	-0.06	0.4348229	0.5651771	1.014772
# SPSS7E	0.55	-0.05	0.2978138	0.7021862	1.016451
# SPSS8E	0.80	0.11	0.6706395	0.3293605	1.039414
# SPSS9E	0.91	-0.10	0.8180204	0.1819796	1.026036
# SPSS10E	-0.10	0.77	0.5874262	0.4125738	1.032749

##########
# Loadings did not change much from oblimin
##########
```
# Possibly method effects?

```{r drop reverse worded items}
EFA.spss.2 <- EFA.spss %>% select(-SPSS2E, -SPSS3E, -SPSS10E)
```

```{r rerun VSS/PA}
VSS(EFA.spss.2, plot = F)

fa.parallel(EFA.spss.2, fm="ml", fa='both', n.iter=100)


# Very Simple Structure
# Call: vss(x = x, n = n, rotate = rotate, diagonal = diagonal, fm = fm, 
#     n.obs = n.obs, plot = plot, title = title, use = use, cor = cor)
# VSS complexity 1 achieves a maximimum of 0.94  with  1  factors
# VSS complexity 2 achieves a maximimum of 0.95  with  2  factors
# 
# The Velicer MAP achieves a minimum of NA  with  1  factors 
# BIC achieves a minimum of  NA  with  1  factors
# Sample Size adjusted BIC achieves a minimum of  NA  with  3  factors
# 
# Statistics by number of factors 
# Parallel analysis suggests that the number of factors =  1  and the number of components =  1 
```
```{r rerun EFA}
fa(EFA.spss.2, nfactors = 1, fm = "uls", rotate = "oblimin")

# Factor Analysis using method =  uls
# Call: fa(r = EFA.spss.2, nfactors = 1, rotate = "oblimin", fm = "uls")
# Standardized loadings (pattern matrix) based upon correlation matrix
# 
#                ULS1
# SS loadings    4.28
# Proportion Var 0.61
# 
# Mean item complexity =  1
# Test of the hypothesis that 1 factor is sufficient.
# 
# The degrees of freedom for the null model are  21  and the objective function was  4.85 with Chi Square of  373
# The degrees of freedom for the model are 14  and the objective function was  0.24 
# 
# The root mean square of the residuals (RMSR) is  0.03 
# The df corrected root mean square of the residuals is  0.04 
# 
# The harmonic number of observations is  81 with the empirical chi square  3.94  with prob <  1 
# The total number of observations was  81  with Likelihood Chi Square =  18.58  with prob <  0.18 
# 
# Tucker Lewis Index of factoring reliability =  0.98
# RMSEA index =  0.062  and the 90 % confidence intervals are  0 0.134
# BIC =  -42.94
# Fit based upon off diagonal values = 1
# Measures of factor score adequacy             
#                                                   ULS1
# Correlation of (regression) scores with factors   0.97
# Multiple R square of scores with factors          0.94
# Minimum correlation of possible factor scores     0.87
# 
#         ULS1      h2        u2    com
# SPSS1E	0.86	0.7336326	0.2663674	1
# SPSS4E	0.91	0.8202064	0.1797936	1
# SPSS5E	0.71	0.5045856	0.4954144	1
# SPSS6E	0.66	0.4339379	0.5660621	1
# SPSS7E	0.56	0.3174674	0.6825326	1
# SPSS8E	0.83	0.6968142	0.3031858	1
# SPSS9E	0.88	0.7721449	0.2278551	1

##########
# RMSR = .03
# Prop var explained: 61%
# No loadings <.4
# Some communality <.4, but none <.2
##########
```


